@page "/"
@using MAUIBlazorHybridCallBlazorFromTitleBar.Application.Interfaces
@using MAUIBlazorHybridCallBlazorFromTitleBar.Helpers
@implements IDisposable
@inject ITitleBarService TitleBarService

<h1>Calling Blazor code from button in title bar</h1>

<p>
    The purpose of this demo is to show you how to have a click on the button in the title bar call code in the Blazor
    part of your applicaiton
</p>

<p>To try it out, click on the button '&#9881;', '&#9993;' or '?' in the Title Bar.</p>
<p>The ToolBarTools contains code for added more than one button to the Title Bar.</p>

<p>This demo contains the above mentioned buttons. The Help event is implemented in this (Home.razor) component, and the Settings
    and Send Message are implemented in the NavMenu.razor component.</p>

<ModalDialog @ref="modalDialogHelp" Title="Help for Home" OnClose="OnCloseModal">
    <p>This is a modal dialog opened from the title bar help button.</p>
    <p>This is implemented in the Home.razor component, as it must show component specific help-text for this component.</p>
    <p>You can put any content you like here.</p>
</ModalDialog>

<hr />

<p>To tryout the dynamic title bar, enter a new title and sub-title below and click 'Change Title'.</p>

<EditForm class="entryform" OnValidSubmit="ChangeTitle" Model="titles">
    <div>
        <label>Title:</label>
    </div>
    <div>
        <InputText @bind-Value="titles.NewTitle" placeholder="Enter new title" /> <br />
    </div>
    <div>
        <label>Sub-title:</label>
    </div>
    <div>
        <InputText @bind-Value="titles.NewSubTitle" placeholder="Enter new sub-title" /> <br />
    </div>
    <div>
    </div>
    <div>
        <button class="btn btn-primary" type="submit">Change Title</button>
    </div>
</EditForm>

@code {
    public class Titles
    {
        public string NewTitle { get; set; } = string.Empty;
        public string NewSubTitle { get; set; } = string.Empty;
    }

    public Titles titles { get; set; } = new Titles();

    private ModalDialog? modalDialogHelp { get; set; }

    protected override void OnInitialized()
    {
        // Subscribe to the event from WinUI
        TitleBarService.BlazorCalled += CalledFromTitleBarButton;
    }

    /// <summary>
    /// Make call to the TitleBarService to change the title and subtitle.
    /// </summary>
    private void ChangeTitle()
    {
        TitleBarService.SetTitle(titles.NewTitle);
        TitleBarService.SetSubtitle(titles.NewSubTitle);
    }

    /// <summary>
    /// Handle the event from the TitleBarService when a button in the title bar is pressed.
    /// </summary>
    /// <param name="buttonId">Id of the button clicked in the Title Bar</param>
    private async void CalledFromTitleBarButton(string buttonId)
    {
        if (buttonId is TitleBarButtonIds.Help && modalDialogHelp is not null)
        {
            await InvokeAsync(() =>
            {
                if (TitleBarTools.IsDisplayingModalDialog is true)
                {
                    // A modal dialog is already displayed, do not open another one.
                    return;
                }
                TitleBarTools.IsDisplayingModalDialog = true;
                modalDialogHelp.Open();
                StateHasChanged();
            });
        }
    }

    /// <summary>
    /// When closing the modal dialog, reset the flag indicating that a modal dialog is being displayed.
    /// This is needed for opening subsequent modal dialogs.
    /// </summary>
    private void OnCloseModal()
    {
        TitleBarTools.IsDisplayingModalDialog = false;
    }

    /// <summary>
    /// Cleanup at close-down.
    /// </summary>
    public void Dispose()
    {
        // Cancel the subscription to the event to avoid memory leaks.
        TitleBarService.BlazorCalled -= CalledFromTitleBarButton;
    }
}
